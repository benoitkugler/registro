package main

import (
	"encoding/json"
	"fmt"
	"log"
	"os"
	"os/exec"
	"registro/controllers/equipier/communes"
	"strings"
)

// expected the file https://tabular-api.data.gouv.fr/api/resources/5d3cfdd0-00de-43fe-a5db-dffeacec6fc7/data/json/
// from https://www.data.gouv.fr/datasets/base-nationale-sur-les-intercommunalites/

// CommunesFrancaises stores, for each département (0-based), the list
// of commune names (0-based)
//
// Note : Corse is encoded as 100, 101 instead of 2A, 2B
type CommunesFrancaises [101][]string

func main() {
	filepath := os.Args[1]
	f, err := os.Open(filepath)
	if err != nil {
		log.Fatal(err)
	}
	type row struct {
		Code string `json:"Code INSEE de la commune"`
		Nom  string `json:"Nom de la commune"`
	}
	var lines []row
	err = json.NewDecoder(f).Decode(&lines)
	if err != nil {
		log.Fatal(err)
	}
	if len(lines) != 34875 {
		log.Fatal("unexpected number of communes")
	}
	if lines[30620].Nom != "Saint-Germain-en-Laye" {
		log.Fatal()
	}

	// init with maximum length, then trim
	var out CommunesFrancaises
	var lengths [len(out)]int
	for i := range out {
		out[i] = make([]string, 1000)
	}

	for _, line := range lines {
		departement, commune, err := communes.ParseCommuneCode(line.Code)
		if err != nil {
			log.Fatal(err)
		}

		// store at code - 1
		out[departement-1][commune-1] = line.Nom
		lengths[departement-1] = max(lengths[departement-1], commune)
	}

	// trim unused values
	for i, l := range out {
		out[i] = l[:lengths[i]]
	}

	// generate code
	var codeLines [len(out)]string
	for i, dep := range out {
		array := strings.TrimPrefix(fmt.Sprintf("%#v", dep), "[]string")
		codeLines[i] = fmt.Sprintf("%d : %s,\n", i, array)
	}

	code := fmt.Sprintf(`// Code generated by utils/commmunes/main.go DO NOT EDIT

  package communes 

  // communesFrancaises stores, for each département (0-based), the list
  // of commune names (0-based)
  //
  // Note : Corse is encoded as 100, 101 instead of 2A, 2B
  var communesFrancaises = [...][]string{
    %s
  }
  `, strings.Join(codeLines[:], ""))

	const outFile = "controllers/equipier/communes/communes_gen.go"
	err = os.WriteFile(outFile, []byte(code), os.ModePerm)
	if err != nil {
		log.Fatal(err)
	}

	err = exec.Command("gofmt", "-w", outFile).Run()
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println("Code written in", outFile)
}
