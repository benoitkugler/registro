-- generated by make_sql.go DO NOT EDIT.

DROP TYPE IF EXISTS Nationnalite;

CREATE TYPE Nationnalite AS (
    IsSuisse boolean
);

DROP TYPE IF EXISTS Publicite;

CREATE TYPE Publicite AS (
    VersionPapier boolean,
    PubHiver boolean,
    PubEte boolean,
    EchoRocher boolean,
    Eonews boolean
);

DROP TYPE IF EXISTS Montant;

CREATE TYPE Montant AS (
    Cent integer,
    Currency smallint
);

DROP TYPE IF EXISTS DocumentsToShow;

CREATE TYPE DocumentsToShow AS (
    LettreDirecteur boolean,
    ListeVetements boolean,
    ListeParticipants boolean,
    CharteParticipant boolean
);

DROP TYPE IF EXISTS PresenceOffsets;

CREATE TYPE PresenceOffsets AS (
    Debut integer,
    Fin integer
);

CREATE TABLE ficheequipiers (
    IdPersonne integer NOT NULL,
    SecuriteSociale text NOT NULL,
    Fonctionnaire boolean NOT NULL,
    Diplome smallint CHECK (Diplome IN (0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19)) NOT NULL,
    Approfondissement smallint CHECK (Approfondissement IN (0, 1, 2, 3, 4, 5)) NOT NULL,
    EtatCivil smallint CHECK (EtatCivil IN (0, 1, 2)) NOT NULL,
    NombreEnfants integer NOT NULL,
    Formation text NOT NULL,
    Profession text NOT NULL,
    ExperienceTravailJeunes text NOT NULL,
    ParcoursSpirituel text NOT NULL,
    Eglise text NOT NULL,
    Recommandation jsonb NOT NULL,
    Sante text NOT NULL,
    AssuranceMaladie text NOT NULL,
    AssuranceAccident text NOT NULL,
    DemandeMembreAssoPermanent boolean NOT NULL,
    guard boolean NOT NULL
);

CREATE TABLE fichesanitaires (
    IdPersonne integer NOT NULL,
    DifficultesSante text NOT NULL,
    AllergiesAlimentaires text NOT NULL,
    TraitementMedical text NOT NULL,
    Medecin jsonb NOT NULL,
    AutreContact jsonb NOT NULL,
    Modified timestamp(0) with time zone NOT NULL,
    Owners text[],
    guard boolean NOT NULL
);

CREATE TABLE personnes (
    Id serial PRIMARY KEY,
    Nom text NOT NULL,
    Prenom text NOT NULL,
    Sexe smallint CHECK (Sexe IN (0, 1, 2)) NOT NULL,
    DateNaissance date NOT NULL,
    Nationnalite Nationnalite NOT NULL,
    Tels text[],
    Mail text NOT NULL,
    Adresse text NOT NULL,
    CodePostal text NOT NULL,
    Ville text NOT NULL,
    Pays text NOT NULL,
    Publicite Publicite NOT NULL,
    CharteAccepted timestamp(0) with time zone NOT NULL,
    IsTemp boolean NOT NULL
);

CREATE TABLE dossiers (
    Id serial PRIMARY KEY,
    IdTaux integer NOT NULL,
    IdResponsable integer NOT NULL,
    CopiesMails text[],
    PartageAdressesOK boolean NOT NULL,
    DemandeFondSoutien boolean NOT NULL,
    IsValidated boolean NOT NULL,
    MomentInscription timestamp(0) with time zone NOT NULL,
    LastLoadDocuments timestamp(0) with time zone NOT NULL,
    KeyV1 text NOT NULL
);

CREATE TABLE paiements (
    Id serial PRIMARY KEY,
    IdDossier integer NOT NULL,
    IsRemboursement boolean NOT NULL,
    Montant Montant NOT NULL,
    Payeur text NOT NULL,
    Mode smallint CHECK (Mode IN (0, 1, 2, 3, 4, 5)) NOT NULL,
    Time timestamp(0) with time zone NOT NULL,
    Label text NOT NULL,
    Details text NOT NULL
);

CREATE TABLE tauxs (
    Id serial PRIMARY KEY,
    Label text NOT NULL,
    Euros integer NOT NULL,
    FrancsSuisse integer NOT NULL
);

CREATE TABLE aides (
    Id serial PRIMARY KEY,
    IdStructureaide integer NOT NULL,
    IdParticipant integer NOT NULL,
    Valide boolean NOT NULL,
    Valeur Montant NOT NULL,
    ParJour boolean NOT NULL,
    NbJoursMax integer NOT NULL
);

CREATE TABLE camps (
    Id serial PRIMARY KEY,
    IdTaux integer NOT NULL,
    Nom text NOT NULL,
    DateDebut date NOT NULL,
    Duree integer NOT NULL,
    Lieu text NOT NULL,
    Agrement text NOT NULL,
    ImageURL text NOT NULL,
    Description text NOT NULL,
    Navette jsonb NOT NULL,
    Places integer NOT NULL,
    AgeMin integer NOT NULL,
    AgeMax integer NOT NULL,
    NeedEquilibreGF boolean NOT NULL,
    InscriptionExterne boolean NOT NULL,
    Statut smallint CHECK (Statut IN (0, 1, 2)) NOT NULL,
    Prix Montant NOT NULL,
    OptionPrix jsonb NOT NULL,
    OptionQuotientFamilial integer[] CHECK (array_length(OptionQuotientFamilial, 1) = 4) NOT NULL,
    Password text NOT NULL,
    DocumentsReady boolean NOT NULL,
    DocumentsToShow DocumentsToShow NOT NULL,
    Vetements jsonb NOT NULL,
    AlbumID text NOT NULL,
    Meta jsonb NOT NULL
);

CREATE TABLE equipiers (
    Id serial PRIMARY KEY,
    IdCamp integer NOT NULL,
    IdPersonne integer NOT NULL,
    Roles smallint[],
    Presence PresenceOffsets NOT NULL,
    FormStatus smallint CHECK (FormStatus IN (0, 1, 2)) NOT NULL,
    AccepteCharte boolean
);

CREATE TABLE groupes (
    Id serial PRIMARY KEY,
    IdCamp integer NOT NULL,
    Nom text NOT NULL,
    Couleur text NOT NULL,
    Fin date NOT NULL
);

CREATE TABLE groupe_participants (
    IdParticipant integer NOT NULL,
    IdGroupe integer NOT NULL,
    IdCamp integer NOT NULL,
    Manuel boolean NOT NULL
);

CREATE TABLE lettre_images (
    Id serial PRIMARY KEY,
    Filename text NOT NULL,
    Content bytea NOT NULL
);

CREATE TABLE lettredirecteurs (
    IdCamp integer NOT NULL,
    Html text NOT NULL,
    UseCoordCentre boolean NOT NULL,
    ShowAdressePostale boolean NOT NULL,
    ColorCoord text NOT NULL
);

CREATE TABLE participants (
    Id serial PRIMARY KEY,
    IdCamp integer NOT NULL,
    IdPersonne integer NOT NULL,
    IdDossier integer NOT NULL,
    IdTaux integer NOT NULL,
    Statut smallint CHECK (Statut IN (0, 1, 2, 3, 4, 5)) NOT NULL,
    Remises jsonb NOT NULL,
    QuotientFamilial integer NOT NULL,
    OptionPrix jsonb NOT NULL,
    Commentaire text NOT NULL,
    Navette smallint CHECK (Navette IN (0, 1, 2, 3)) NOT NULL
);

CREATE TABLE sondages (
    Id serial PRIMARY KEY,
    IdCamp integer NOT NULL,
    IdDossier integer NOT NULL,
    Modified timestamp(0) with time zone NOT NULL,
    InfosAvantSejour smallint CHECK (InfosAvantSejour IN (0, 1, 2, 3, 4)) NOT NULL,
    InfosPendantSejour smallint CHECK (InfosPendantSejour IN (0, 1, 2, 3, 4)) NOT NULL,
    Hebergement smallint CHECK (Hebergement IN (0, 1, 2, 3, 4)) NOT NULL,
    Activites smallint CHECK (Activites IN (0, 1, 2, 3, 4)) NOT NULL,
    Theme smallint CHECK (Theme IN (0, 1, 2, 3, 4)) NOT NULL,
    Nourriture smallint CHECK (Nourriture IN (0, 1, 2, 3, 4)) NOT NULL,
    Hygiene smallint CHECK (Hygiene IN (0, 1, 2, 3, 4)) NOT NULL,
    Ambiance smallint CHECK (Ambiance IN (0, 1, 2, 3, 4)) NOT NULL,
    Ressenti smallint CHECK (Ressenti IN (0, 1, 2, 3, 4)) NOT NULL,
    MessageEnfant text NOT NULL,
    MessageResponsable text NOT NULL
);

CREATE TABLE structureaides (
    Id serial PRIMARY KEY,
    Nom text NOT NULL,
    Immatriculation text NOT NULL,
    Info text NOT NULL
);

CREATE TABLE demandes (
    Id serial PRIMARY KEY,
    IdFile integer,
    IdDirecteur integer,
    Categorie smallint CHECK (Categorie IN (0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)) NOT NULL,
    Description text NOT NULL,
    MaxDocs integer NOT NULL,
    JoursValide integer NOT NULL
);

CREATE TABLE demande_camps (
    IdCamp integer NOT NULL,
    IdDemande integer NOT NULL
);

CREATE TABLE demande_equipiers (
    IdEquipier integer NOT NULL,
    IdDemande integer NOT NULL,
    Optionnelle boolean NOT NULL
);

CREATE TABLE files (
    Id serial PRIMARY KEY,
    Taille integer NOT NULL,
    NomClient text NOT NULL,
    Uploaded timestamp(0) with time zone NOT NULL
);

CREATE TABLE file_aides (
    IdFile integer NOT NULL,
    IdAide integer NOT NULL
);

CREATE TABLE file_camps (
    IdFile integer NOT NULL,
    IdCamp integer NOT NULL,
    IsLettre boolean NOT NULL
);

CREATE TABLE file_personnes (
    IdFile integer NOT NULL,
    IdPersonne integer NOT NULL,
    IdDemande integer NOT NULL,
    guard boolean NOT NULL
);

CREATE TABLE inscriptions (
    Id serial PRIMARY KEY,
    IdTaux integer NOT NULL,
    Responsable jsonb NOT NULL,
    Message text NOT NULL,
    CopiesMails text[],
    PartageAdressesOK boolean NOT NULL,
    DemandeFondSoutien boolean NOT NULL,
    DateHeure timestamp(0) with time zone NOT NULL,
    ConfirmedAsDossier integer
);

CREATE TABLE inscription_participants (
    IdInscription integer NOT NULL,
    IdCamp integer NOT NULL,
    IdTaux integer NOT NULL,
    Nom text NOT NULL,
    Prenom text NOT NULL,
    DateNaissance date NOT NULL,
    Sexe smallint CHECK (Sexe IN (0, 1, 2)) NOT NULL,
    Nationnalite Nationnalite NOT NULL
);

CREATE TABLE events (
    Id serial PRIMARY KEY,
    IdDossier integer NOT NULL,
    Kind smallint CHECK (Kind IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL,
    Created timestamp(0) with time zone NOT NULL
);

CREATE TABLE event_attestations (
    IdEvent integer NOT NULL,
    Distribution smallint CHECK (Distribution IN (0, 1, 2)) NOT NULL,
    IsPresence boolean NOT NULL,
    guard smallint CHECK (guard IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL
);

CREATE TABLE event_camp_docss (
    IdEvent integer NOT NULL,
    IdCamp integer NOT NULL,
    guard smallint CHECK (guard IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL
);

CREATE TABLE event_messages (
    IdEvent integer NOT NULL,
    Contenu text NOT NULL,
    Origine smallint CHECK (Origine IN (0, 1, 2, 3)) NOT NULL,
    OrigineCamp integer,
    VuBackoffice boolean NOT NULL,
    VuEspaceperso boolean NOT NULL,
    VuFondSoutien boolean NOT NULL,
    OnlyToFondSoutien boolean NOT NULL,
    guard smallint CHECK (guard IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL
);

CREATE TABLE event_message_vus (
    IdEvent integer NOT NULL,
    IdCamp integer NOT NULL,
    guard smallint CHECK (guard IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL
);

CREATE TABLE event_place_liberees (
    IdEvent integer NOT NULL,
    IdParticipant integer NOT NULL,
    Accepted boolean NOT NULL,
    guard smallint CHECK (guard IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL
);

CREATE TABLE event_sondages (
    IdEvent integer NOT NULL,
    IdCamp integer NOT NULL,
    guard smallint CHECK (guard IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL
);

CREATE TABLE event_validations (
    IdEvent integer NOT NULL,
    IdCamp integer,
    guard smallint CHECK (guard IN (0, 1, 2, 3, 4, 5, 6, 7)) NOT NULL
);

CREATE TABLE dons (
    Id serial PRIMARY KEY,
    IdPersonne integer,
    IdOrganisme integer,
    Montant Montant NOT NULL,
    ModePaiement smallint CHECK (ModePaiement IN (0, 1, 2, 3, 4, 5)) NOT NULL,
    Date date NOT NULL,
    Affectation text NOT NULL,
    Details text NOT NULL,
    Remercie boolean NOT NULL
);

CREATE TABLE organismes (
    Id serial PRIMARY KEY,
    Nom text NOT NULL,
    Mail text NOT NULL,
    Adresse text NOT NULL,
    CodePostal text NOT NULL,
    Ville text NOT NULL,
    Pays text NOT NULL
);

-- generated by make_sql.go DO NOT EDIT.

CREATE OR REPLACE FUNCTION gomacro_validate_json_pers_NomTel (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Nom', 'Tel'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_string (data -> 'Nom')
        AND gomacro_validate_json_string (data -> 'Tel');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_pers_Recommandation (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Nom', 'Prenom', 'Mail', 'Tel'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_string (data -> 'Nom')
        AND gomacro_validate_json_string (data -> 'Prenom')
        AND gomacro_validate_json_string (data -> 'Mail')
        AND gomacro_validate_json_string (data -> 'Tel');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_string (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'string';
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a string', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_array_camp_PrixParStatut (data jsonb)
    RETURNS boolean
    AS $$
BEGIN
    IF jsonb_typeof(data) = 'null' THEN
        RETURN TRUE;
    END IF;
    IF jsonb_typeof(data) != 'array' THEN
        RETURN FALSE;
    END IF;
    IF jsonb_array_length(data) = 0 THEN
        RETURN TRUE;
    END IF;
    RETURN (
        SELECT
            bool_and(gomacro_validate_json_camp_PrixParStatut (value))
        FROM
            jsonb_array_elements(data));
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_array_camp_Vetement (data jsonb)
    RETURNS boolean
    AS $$
BEGIN
    IF jsonb_typeof(data) = 'null' THEN
        RETURN TRUE;
    END IF;
    IF jsonb_typeof(data) != 'array' THEN
        RETURN FALSE;
    END IF;
    IF jsonb_array_length(data) = 0 THEN
        RETURN TRUE;
    END IF;
    RETURN (
        SELECT
            bool_and(gomacro_validate_json_camp_Vetement (value))
        FROM
            jsonb_array_elements(data));
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_array_number (data jsonb)
    RETURNS boolean
    AS $$
BEGIN
    IF jsonb_typeof(data) = 'null' THEN
        RETURN TRUE;
    END IF;
    IF jsonb_typeof(data) != 'array' THEN
        RETURN FALSE;
    END IF;
    IF jsonb_array_length(data) = 0 THEN
        RETURN TRUE;
    END IF;
    RETURN (
        SELECT
            bool_and(gomacro_validate_json_number (value))
        FROM
            jsonb_array_elements(data));
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_boolean (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'boolean';
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a boolean', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_ListeVetements (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Vetements', 'Complement'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_array_camp_Vetement (data -> 'Vetements')
        AND gomacro_validate_json_string (data -> 'Complement');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_OptionNavette (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Actif', 'Commentaire'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_boolean (data -> 'Actif')
        AND gomacro_validate_json_string (data -> 'Commentaire');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_OptionPrixCamp (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Active', 'Statuts', 'Jours'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_camp_OptionPrixKind (data -> 'Active')
        AND gomacro_validate_json_array_camp_PrixParStatut (data -> 'Statuts')
        AND gomacro_validate_json_array_number (data -> 'Jours');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_OptionPrixKind (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'number'
    AND data::int IN (0, 1, 2);
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a camp_OptionPrixKind', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_OptionPrixParticipant (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('IdStatut', 'Jour'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_number (data -> 'IdStatut')
        AND gomacro_validate_json_array_number (data -> 'Jour');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_PrixParStatut (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Id', 'Prix', 'Label', 'Description'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_number (data -> 'Id')
        AND gomacro_validate_json_number (data -> 'Prix')
        AND gomacro_validate_json_string (data -> 'Label')
        AND gomacro_validate_json_string (data -> 'Description');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_Remises (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Equipiers', 'Famille', 'Speciale'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_number (data -> 'Equipiers')
        AND gomacro_validate_json_number (data -> 'Famille')
        AND gomacro_validate_json_doss_Montant (data -> 'Speciale');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_camp_Vetement (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Quantite', 'Description', 'Important'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_number (data -> 'Quantite')
        AND gomacro_validate_json_string (data -> 'Description')
        AND gomacro_validate_json_boolean (data -> 'Important');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_doss_Currency (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'number'
    AND data::int IN (0, 1);
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a doss_Currency', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_doss_Montant (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Cent', 'Currency'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_number (data -> 'Cent')
        AND gomacro_validate_json_doss_Currency (data -> 'Currency');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_map_string (data jsonb)
    RETURNS boolean
    AS $$
BEGIN
    IF jsonb_typeof(data) = 'null' THEN
        -- accept null value coming from nil maps
        RETURN TRUE;
    END IF;
    RETURN jsonb_typeof(data) = 'object'
        AND (
            SELECT
                bool_and(gomacro_validate_json_string (value))
            FROM
                jsonb_each(data));
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_number (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'number';
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a number', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_string (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'string';
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a string', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_array_string (data jsonb)
    RETURNS boolean
    AS $$
BEGIN
    IF jsonb_typeof(data) = 'null' THEN
        RETURN TRUE;
    END IF;
    IF jsonb_typeof(data) != 'array' THEN
        RETURN FALSE;
    END IF;
    IF jsonb_array_length(data) = 0 THEN
        RETURN TRUE;
    END IF;
    RETURN (
        SELECT
            bool_and(gomacro_validate_json_string (value))
        FROM
            jsonb_array_elements(data));
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_insc_ResponsableLegal (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean;
BEGIN
    IF jsonb_typeof(data) != 'object' THEN
        RETURN FALSE;
    END IF;
    is_valid := (
        SELECT
            bool_and(key IN ('Nom', 'Prenom', 'DateNaissance', 'Sexe', 'Mail', 'Tels', 'Adresse', 'CodePostal', 'Ville', 'Pays'))
        FROM
            jsonb_each(data))
        AND gomacro_validate_json_string (data -> 'Nom')
        AND gomacro_validate_json_string (data -> 'Prenom')
        AND gomacro_validate_json_string (data -> 'DateNaissance')
        AND gomacro_validate_json_pers_Sexe (data -> 'Sexe')
        AND gomacro_validate_json_string (data -> 'Mail')
        AND gomacro_validate_json_array_string (data -> 'Tels')
        AND gomacro_validate_json_string (data -> 'Adresse')
        AND gomacro_validate_json_string (data -> 'CodePostal')
        AND gomacro_validate_json_string (data -> 'Ville')
        AND gomacro_validate_json_string (data -> 'Pays');
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_pers_Sexe (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'number'
    AND data::int IN (0, 1, 2);
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a pers_Sexe', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

CREATE OR REPLACE FUNCTION gomacro_validate_json_string (data jsonb)
    RETURNS boolean
    AS $$
DECLARE
    is_valid boolean := jsonb_typeof(data) = 'string';
BEGIN
    IF NOT is_valid THEN
        RAISE WARNING '% is not a string', data;
    END IF;
    RETURN is_valid;
END;
$$
LANGUAGE 'plpgsql'
IMMUTABLE;

-- generated by make_sql.go DO NOT EDIT.

ALTER TABLE personnes
    ADD UNIQUE (Id, IsTemp);

ALTER TABLE fichesanitaires
    ADD UNIQUE (IdPersonne);

ALTER TABLE fichesanitaires
    ADD FOREIGN KEY (IdPersonne, guard) REFERENCES personnes (Id, IsTemp);

ALTER TABLE fichesanitaires
    ADD FOREIGN KEY (IdPersonne) REFERENCES personnes ON DELETE CASCADE;

ALTER TABLE fichesanitaires
    ALTER COLUMN guard SET DEFAULT FALSE;

ALTER TABLE fichesanitaires
    ADD CHECK (guard = FALSE);

ALTER TABLE ficheequipiers
    ADD UNIQUE (IdPersonne);

ALTER TABLE ficheequipiers
    ADD FOREIGN KEY (IdPersonne, guard) REFERENCES personnes (Id, IsTemp);

ALTER TABLE ficheequipiers
    ADD FOREIGN KEY (IdPersonne) REFERENCES personnes ON DELETE CASCADE;

ALTER TABLE ficheequipiers
    ALTER COLUMN guard SET DEFAULT FALSE;

ALTER TABLE ficheequipiers
    ADD CHECK (guard = FALSE);

ALTER TABLE fichesanitaires
    ADD CONSTRAINT AutreContact_gomacro CHECK (gomacro_validate_json_pers_NomTel (AutreContact));

ALTER TABLE fichesanitaires
    ADD CONSTRAINT Medecin_gomacro CHECK (gomacro_validate_json_pers_NomTel (Medecin));

ALTER TABLE ficheequipiers
    ADD CONSTRAINT Recommandation_gomacro CHECK (gomacro_validate_json_pers_Recommandation (Recommandation));

ALTER TABLE tauxs
    ADD UNIQUE (Label);

ALTER TABLE tauxs
    ADD CHECK (Euros = 1000);

ALTER TABLE dossiers
    ADD UNIQUE (Id, IdTaux);

ALTER TABLE dossiers
    ADD FOREIGN KEY (IdTaux) REFERENCES tauxs;

ALTER TABLE dossiers
    ADD FOREIGN KEY (IdResponsable) REFERENCES personnes;

ALTER TABLE paiements
    ADD FOREIGN KEY (IdDossier) REFERENCES dossiers ON DELETE CASCADE;

ALTER TABLE camps
    ADD UNIQUE (Id, IdTaux);

ALTER TABLE camps
    ADD FOREIGN KEY (IdTaux) REFERENCES tauxs;

ALTER TABLE lettredirecteurs
    ADD UNIQUE (IdCamp);

ALTER TABLE lettredirecteurs
    ADD FOREIGN KEY (IdCamp) REFERENCES camps ON DELETE CASCADE;

ALTER TABLE participants
    ADD FOREIGN KEY (IdCamp, IdTaux) REFERENCES camps (Id, IdTaux);

ALTER TABLE participants
    ADD FOREIGN KEY (IdDossier, IdTaux) REFERENCES dossiers (Id, IdTaux) ON DELETE CASCADE;

ALTER TABLE participants
    ADD UNIQUE (IdCamp, IdPersonne);

ALTER TABLE participants
    ADD UNIQUE (Id, IdCamp);

ALTER TABLE participants
    ADD FOREIGN KEY (IdCamp) REFERENCES camps;

ALTER TABLE participants
    ADD FOREIGN KEY (IdPersonne) REFERENCES personnes;

ALTER TABLE participants
    ADD FOREIGN KEY (IdDossier) REFERENCES dossiers ON DELETE CASCADE;

ALTER TABLE participants
    ADD FOREIGN KEY (IdTaux) REFERENCES tauxs;

ALTER TABLE groupes
    ADD UNIQUE (IdCamp, Nom);

ALTER TABLE groupes
    ADD UNIQUE (Id, IdCamp);

ALTER TABLE groupes
    ADD FOREIGN KEY (IdCamp) REFERENCES camps ON DELETE CASCADE;

ALTER TABLE groupe_participants
    ADD UNIQUE (IdParticipant);

ALTER TABLE groupe_participants
    ADD UNIQUE (IdParticipant, IdCamp);

ALTER TABLE groupe_participants
    ADD FOREIGN KEY (IdParticipant, IdCamp) REFERENCES participants (Id, IdCamp) ON DELETE CASCADE;

ALTER TABLE groupe_participants
    ADD FOREIGN KEY (IdGroupe, IdCamp) REFERENCES groupes (Id, IdCamp) ON DELETE CASCADE;

ALTER TABLE groupe_participants
    ADD FOREIGN KEY (IdParticipant) REFERENCES participants ON DELETE CASCADE;

ALTER TABLE groupe_participants
    ADD FOREIGN KEY (IdGroupe) REFERENCES groupes ON DELETE CASCADE;

ALTER TABLE groupe_participants
    ADD FOREIGN KEY (IdCamp) REFERENCES camps;

ALTER TABLE sondages
    ADD UNIQUE (IdCamp, IdDossier);

ALTER TABLE sondages
    ADD FOREIGN KEY (IdCamp) REFERENCES camps ON DELETE CASCADE;

ALTER TABLE sondages
    ADD FOREIGN KEY (IdDossier) REFERENCES dossiers ON DELETE CASCADE;

ALTER TABLE aides
    ADD FOREIGN KEY (IdStructureaide) REFERENCES structureaides;

ALTER TABLE aides
    ADD FOREIGN KEY (IdParticipant) REFERENCES participants ON DELETE CASCADE;

ALTER TABLE equipiers
    ADD UNIQUE (IdCamp, IdPersonne);

CREATE UNIQUE INDEX ON equipiers (IdCamp)
WHERE
    0
    /* Role.Direction */
    = ANY (Roles);

ALTER TABLE equipiers
    ADD FOREIGN KEY (IdCamp) REFERENCES camps ON DELETE CASCADE;

ALTER TABLE equipiers
    ADD FOREIGN KEY (IdPersonne) REFERENCES personnes ON DELETE CASCADE;

ALTER TABLE camps
    ADD CONSTRAINT Vetements_gomacro CHECK (gomacro_validate_json_camp_ListeVetements (Vetements));

ALTER TABLE camps
    ADD CONSTRAINT Navette_gomacro CHECK (gomacro_validate_json_camp_OptionNavette (Navette));

ALTER TABLE camps
    ADD CONSTRAINT OptionPrix_gomacro CHECK (gomacro_validate_json_camp_OptionPrixCamp (OptionPrix));

ALTER TABLE participants
    ADD CONSTRAINT OptionPrix_gomacro CHECK (gomacro_validate_json_camp_OptionPrixParticipant (OptionPrix));

ALTER TABLE participants
    ADD CONSTRAINT Remises_gomacro CHECK (gomacro_validate_json_camp_Remises (Remises));

ALTER TABLE camps
    ADD CONSTRAINT Meta_gomacro CHECK (gomacro_validate_json_map_string (Meta));

ALTER TABLE demandes
    ADD CONSTRAINT constraint_categorie CHECK (Categorie = 0 OR IdDirecteur IS NULL);

ALTER TABLE demandes
    ADD CONSTRAINT constraint_maxdocs CHECK (MaxDocs >= 1);

CREATE UNIQUE INDEX ON demandes (Categorie)
WHERE
    Categorie <> 0;

ALTER TABLE demandes
    ADD FOREIGN KEY (IdFile) REFERENCES files ON DELETE SET NULL;

ALTER TABLE demandes
    ADD FOREIGN KEY (IdDirecteur) REFERENCES personnes ON DELETE CASCADE;

ALTER TABLE demande_equipiers
    ADD UNIQUE (IdEquipier, IdDemande);

ALTER TABLE demande_equipiers
    ADD FOREIGN KEY (IdEquipier) REFERENCES equipiers ON DELETE CASCADE;

ALTER TABLE demande_equipiers
    ADD FOREIGN KEY (IdDemande) REFERENCES demandes ON DELETE CASCADE;

ALTER TABLE demande_camps
    ADD UNIQUE (IdCamp, IdDemande);

ALTER TABLE demande_camps
    ADD FOREIGN KEY (IdCamp) REFERENCES camps ON DELETE CASCADE;

ALTER TABLE demande_camps
    ADD FOREIGN KEY (IdDemande) REFERENCES demandes ON DELETE CASCADE;

ALTER TABLE file_camps
    ADD UNIQUE (IdFile);

CREATE UNIQUE INDEX ON file_camps (IdCamp)
WHERE
    IsLettre IS TRUE;

ALTER TABLE file_camps
    ADD FOREIGN KEY (IdFile) REFERENCES files ON DELETE CASCADE;

ALTER TABLE file_camps
    ADD FOREIGN KEY (IdCamp) REFERENCES camps;

ALTER TABLE file_personnes
    ADD UNIQUE (IdFile);

ALTER TABLE file_personnes
    ADD FOREIGN KEY (IdPersonne, guard) REFERENCES personnes (Id, IsTemp);

ALTER TABLE file_personnes
    ADD FOREIGN KEY (IdFile) REFERENCES files ON DELETE CASCADE;

ALTER TABLE file_personnes
    ADD FOREIGN KEY (IdPersonne) REFERENCES personnes;

ALTER TABLE file_personnes
    ADD FOREIGN KEY (IdDemande) REFERENCES demandes;

ALTER TABLE file_personnes
    ALTER COLUMN guard SET DEFAULT FALSE;

ALTER TABLE file_personnes
    ADD CHECK (guard = FALSE);

ALTER TABLE file_aides
    ADD UNIQUE (IdFile);

ALTER TABLE file_aides
    ADD UNIQUE (IdAide);

ALTER TABLE file_aides
    ADD FOREIGN KEY (IdFile) REFERENCES files ON DELETE CASCADE;

ALTER TABLE file_aides
    ADD FOREIGN KEY (IdAide) REFERENCES aides;

ALTER TABLE inscriptions
    ADD UNIQUE (Id, IdTaux);

ALTER TABLE inscriptions
    ADD FOREIGN KEY (IdTaux) REFERENCES tauxs;

ALTER TABLE inscriptions
    ADD FOREIGN KEY (ConfirmedAsDossier) REFERENCES dossiers ON DELETE SET NULL;

ALTER TABLE inscription_participants
    ADD FOREIGN KEY (IdCamp, IdTaux) REFERENCES camps (Id, IdTaux) ON DELETE CASCADE;

ALTER TABLE inscription_participants
    ADD FOREIGN KEY (IdInscription, IdTaux) REFERENCES inscriptions (Id, IdTaux) ON DELETE CASCADE;

ALTER TABLE inscription_participants
    ADD FOREIGN KEY (IdInscription) REFERENCES inscriptions ON DELETE CASCADE;

ALTER TABLE inscription_participants
    ADD FOREIGN KEY (IdCamp) REFERENCES camps ON DELETE CASCADE;

ALTER TABLE inscription_participants
    ADD FOREIGN KEY (IdTaux) REFERENCES tauxs;

ALTER TABLE inscriptions
    ADD CONSTRAINT Responsable_gomacro CHECK (gomacro_validate_json_insc_ResponsableLegal (Responsable));

ALTER TABLE events
    ADD UNIQUE (Id, Kind);

ALTER TABLE events
    ADD FOREIGN KEY (IdDossier) REFERENCES dossiers ON DELETE CASCADE;

ALTER TABLE event_validations
    ADD UNIQUE (IdEvent);

ALTER TABLE event_validations
    ADD FOREIGN KEY (IdEvent, guard) REFERENCES events (Id, Kind) ON DELETE CASCADE;

ALTER TABLE event_validations
    ADD FOREIGN KEY (IdEvent) REFERENCES events;

ALTER TABLE event_validations
    ALTER COLUMN guard SET DEFAULT 1
    /* EventKind.Validation */
;

ALTER TABLE event_validations
    ADD CHECK (guard = 1
    /* EventKind.Validation */);

ALTER TABLE event_messages
    ADD UNIQUE (IdEvent);

ALTER TABLE event_messages
    ADD FOREIGN KEY (IdEvent, guard) REFERENCES events (Id, Kind) ON DELETE CASCADE;

ALTER TABLE event_messages
    ADD CHECK (Origine <> 3
    /* Acteur.Directeur */
        OR OrigineCamp IS NOT NULL);

ALTER TABLE event_messages
    ADD CHECK (Origine = 3
    /* Acteur.Directeur */
        OR OrigineCamp IS NULL);

ALTER TABLE event_messages
    ADD FOREIGN KEY (IdEvent) REFERENCES events ON DELETE CASCADE;

ALTER TABLE event_messages
    ADD FOREIGN KEY (OrigineCamp) REFERENCES camps;

ALTER TABLE event_messages
    ALTER COLUMN guard SET DEFAULT 2
    /* EventKind.Message */
;

ALTER TABLE event_messages
    ADD CHECK (guard = 2
    /* EventKind.Message */);

ALTER TABLE event_message_vus
    ADD FOREIGN KEY (IdEvent, guard) REFERENCES events (Id, Kind) ON DELETE CASCADE;

ALTER TABLE event_message_vus
    ADD UNIQUE (IdEvent, IdCamp);

ALTER TABLE event_message_vus
    ADD FOREIGN KEY (IdEvent) REFERENCES events ON DELETE CASCADE;

ALTER TABLE event_message_vus
    ADD FOREIGN KEY (IdCamp) REFERENCES camps ON DELETE CASCADE;

ALTER TABLE event_message_vus
    ALTER COLUMN guard SET DEFAULT 2
    /* EventKind.Message */
;

ALTER TABLE event_message_vus
    ADD CHECK (guard = 2
    /* EventKind.Message */);

ALTER TABLE event_camp_docss
    ADD UNIQUE (IdEvent);

ALTER TABLE event_camp_docss
    ADD FOREIGN KEY (IdEvent, guard) REFERENCES events (Id, Kind) ON DELETE CASCADE;

ALTER TABLE event_camp_docss
    ADD FOREIGN KEY (IdEvent) REFERENCES events ON DELETE CASCADE;

ALTER TABLE event_camp_docss
    ADD FOREIGN KEY (IdCamp) REFERENCES camps;

ALTER TABLE event_camp_docss
    ALTER COLUMN guard SET DEFAULT 5
    /* EventKind.CampDocs */
;

ALTER TABLE event_camp_docss
    ADD CHECK (guard = 5
    /* EventKind.CampDocs */);

ALTER TABLE event_sondages
    ADD UNIQUE (IdEvent);

ALTER TABLE event_sondages
    ADD FOREIGN KEY (IdEvent, guard) REFERENCES events (Id, Kind) ON DELETE CASCADE;

ALTER TABLE event_sondages
    ADD FOREIGN KEY (IdEvent) REFERENCES events ON DELETE CASCADE;

ALTER TABLE event_sondages
    ADD FOREIGN KEY (IdCamp) REFERENCES camps;

ALTER TABLE event_sondages
    ALTER COLUMN guard SET DEFAULT 7
    /* EventKind.Sondage */
;

ALTER TABLE event_sondages
    ADD CHECK (guard = 7
    /* EventKind.Sondage */);

ALTER TABLE event_place_liberees
    ADD UNIQUE (IdEvent);

ALTER TABLE event_place_liberees
    ADD FOREIGN KEY (IdEvent, guard) REFERENCES events (Id, Kind) ON DELETE CASCADE;

ALTER TABLE event_place_liberees
    ADD FOREIGN KEY (IdEvent) REFERENCES events ON DELETE CASCADE;

ALTER TABLE event_place_liberees
    ADD FOREIGN KEY (IdParticipant) REFERENCES participants;

ALTER TABLE event_place_liberees
    ALTER COLUMN guard SET DEFAULT 3
    /* EventKind.PlaceLiberee */
;

ALTER TABLE event_place_liberees
    ADD CHECK (guard = 3
    /* EventKind.PlaceLiberee */);

ALTER TABLE event_attestations
    ADD UNIQUE (IdEvent);

ALTER TABLE event_attestations
    ADD FOREIGN KEY (IdEvent, guard) REFERENCES events (Id, Kind) ON DELETE CASCADE;

ALTER TABLE event_attestations
    ADD FOREIGN KEY (IdEvent) REFERENCES events ON DELETE CASCADE;

ALTER TABLE event_attestations
    ALTER COLUMN guard SET DEFAULT 6
    /* EventKind.Attestation */
;

ALTER TABLE event_attestations
    ADD CHECK (guard = 6
    /* EventKind.Attestation */);

ALTER TABLE dons
    ADD FOREIGN KEY (IdPersonne) REFERENCES personnes;

ALTER TABLE dons
    ADD FOREIGN KEY (IdOrganisme) REFERENCES organismes;

--
-- Script to be run after the DB creation (mandatory, assumed by the server code)
--
--
-- Default Taux

INSERT INTO tauxs
    VALUES (1, 'Euros seulement (par défaut)', 1000, 0);

SELECT
    setval('tauxs_id_seq', (
            SELECT
                max(id)
            FROM tauxs));

-- Builtin Demandes
INSERT INTO demandes (Categorie, Description, MaxDocs, JoursValide)
    VALUES
        --
        (1, '', 2, 0),
        --
        (2, '', 2, 0),
        --
        (3, '', 1, 0),
        --
        (4, '', 1, 0),
        --
        (5, '', 1, 0),
        --
        (6, '', 1, 0),
        --
        (7, '', 2, 0),
        --
        (8, 'Vaccins', 5, 0),
        --
        (9, 'Certificat délivré sur place après une formation.', 1, 0),
        --
        (10, '', 1, 0),
        --
        (11, '', 1, 0),
        --
        (12, 'Non contre-indication à la cuisine de collectivité, à demander à son médecin traitant.', 1, 90),
        --
        (13, '', 1, 0),
        --
        (14, '', 1, 0),
        --
        (15, '', 1, 0);

SELECT
    setval('demandes_id_seq', (
            SELECT
                max(id)
            FROM demandes));

